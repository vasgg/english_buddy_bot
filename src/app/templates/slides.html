{% extends "base.html" %}
{% block title %}Slides{% endblock %}
{% block content %}
<script>
    function confirmSlideDeletion(slideId) {
        if (confirm('Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ ÑĞ»Ğ°Ğ¹Ğ´?')) {
        fetch(`/slides/${slideId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            window.location.reload(); // ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹
        })
        .catch(error => {
            alert('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸: ' + error);
        });
    }
    }
    function editSlide(slideId) {
    window.location.href = `/slides/${slideId}`;
    }

    function saveSlideOrder() {
    let slides = [];
    let rows = document.querySelectorAll("#slidesTable tr");

    rows.forEach((row, index) => {
        let slideId = row.getAttribute('data-slide-id');
        let lessonId = row.getAttribute('data-lesson-id');
        let nextSlideId = index < rows.length - 1 ? rows[index + 1].getAttribute('data-slide-id') : null;

        slides.push({ lesson_id: lessonId, slide_id: slideId, next_slide: nextSlideId });
    });

    fetch('/save-slide-order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ slides: slides })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        alert("Order saved successfully");
        // ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞ°
        location.reload();
    })
    .catch(error => {
        console.error("Could not save slide order:", error);
        alert("Error saving order: " + error);
    });
    }
    // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞ»Ğ°Ğ¹Ğ´Ğ°
    function addNewSlide(slideId) {
        console.log("Adding new slide after slide ID:", slideId); // Ğ”Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
        fetch('/add-slide', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ slide_id: slideId })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log(data.message);
            // Ğ—Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°
            // ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑĞ»Ğ°Ğ¹Ğ´
            location.reload();
        })
        .catch(error => {
            console.error("Could not add new slide:", error);
            console.log(slideId, error);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // ĞŸĞµÑ€ĞµĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ ÑĞ»Ğ°Ğ¹Ğ´Ğ¾Ğ² Ğ²Ğ²ĞµÑ€Ñ…
        document.querySelectorAll('.move-up').forEach(button => {
            button.addEventListener('click', function() {
                let row = this.parentNode.parentNode;
                if (row.previousElementSibling) {
                    row.parentNode.insertBefore(row, row.previousElementSibling);
                }
            });
        });

        // ĞŸĞµÑ€ĞµĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ ÑĞ»Ğ°Ğ¹Ğ´Ğ¾Ğ² Ğ²Ğ½Ğ¸Ğ·
        document.querySelectorAll('.move-down').forEach(button => {
            button.addEventListener('click', function() {
                let row = this.parentNode.parentNode;
                if (row.nextElementSibling) {
                    row.parentNode.insertBefore(row.nextElementSibling, row);
                }
            });
        });

        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞ»Ğ°Ğ¹Ğ´Ğ°
        document.querySelectorAll('.add-slide').forEach(button => {
            button.addEventListener('click', function() {
                let currentSlideId = this.getAttribute('data-slide-id');
                addNewSlide(currentSlideId);
            });
        });
    });


</script>

<div class="container mt-4">
    <h2>{{ lesson.title }}</h2>
    <p></p>
    <table class="slides-table" id="slidesTable">
        {% for slide in slides %}
        <tr data-slide-id="{{ slide.id }}" data-lesson-id="{{ slide.lesson_id }}">
            {% if slide.slide_type.value == 'text' %}
            <td>ğŸ–‹ï¸</td>
            <td>{{ slide.text }}</td>
            <td>{{ slide.keyboard_type | default('', true) }}</td>
            {% elif slide.slide_type.value == 'image' %}
            <td>ğŸ–¼ï¸</td>
            <td>{{ slide.picture }}</td>
            <td>{{ slide.keyboard_type | default('', true) }}</td>
            {% elif slide.slide_type.value == 'pin_dict' %}
            <td>ğŸ“</td>
            <td>{{ slide.text }}</td>
            <td></td>
            {% elif slide.slide_type.value == 'small_sticker' %}
            <td>ğŸ§¨</td>
            <td>{{ slide.slide_type.value }}</td>
            <td></td>
            {% elif slide.slide_type.value == 'big_sticker' %}
            <td>ğŸ’£</td>
            <td>{{ slide.slide_type.value }}</td>
            <td></td>
            {% elif slide.slide_type.value == 'quiz_options' %}
            <td>ğŸ§©</td>
            <td>{{ slide.text }}</td>
            <td>{{ slide.keyboard }}</td>
            {% elif slide.slide_type.value == 'quiz_input_word' %}
            <td>ğŸ—¨ï¸</td>
            <td>{{ slide.text }}</td>
            <td>{{ slide.right_answers }}</td>
            {% elif slide.slide_type.value == 'quiz_input_phrase' %}
            <td>ğŸ’¬</td>
            <td>{{ slide.text }}</td>
            <td>{{ slide.right_answers }}</td>
            {% elif slide.slide_type.value == 'final_slide' %}
            <td>ğŸ‰</td>
            <td>{{ slide.text }}</td>
            <td></td>
            {% endif %}
            <td>
                <button class="edit-button" onclick="editSlide({{ slide.id }})">âœï¸</button>
            </td>
            <td>
                <button class="move-up" {% if loop.first %}disabled{% endif %}>âˆ†</button>
            </td>
            <td>
                <button class="move-down" {% if loop.last %}disabled{% endif %}>âˆ‡</button>
            </td>
            <td>
                <button class="add-slide" data-slide-id="{{ slide.next_slide }}">+</button>
            </td>
            <td>
                <button class="delete-slide" onclick="confirmSlideDeletion({{ slide.id }})">âˆ’</button>
            </td>
        </tr>
        {% endfor %}
    </table>
</div>


{% endblock %}
{% block sidebar_content %}
<div class="sidebar__button-wrapper">
    <button class="btn btn-primary" onclick="saveSlideOrder()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
</div>
{% endblock %}
